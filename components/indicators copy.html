<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Индекс качества жизни</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        /* Основной стиль */
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #f3f4f6, #e2e5ea);
        }

        /* Карта */
        #map {
            flex: 1;
            width: 100%; /* Убедиться в заполнении ширины */
            height: 100%; /* Убедиться в заполнении высоты */
        }

        /* Сайдбар */
        .sidebar {
            width: 400px;
            max-width: 80%; /* Для мобильных устройств */
            padding: 12px;
            background: rgba(20, 30, 50, 0.95);
            color: #ffffff;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            height: 100%; /* Полная высота */
            position: fixed; /* Фиксация на экране */
            left: 0;
            top: 0;
            transition: transform 0.3s ease, opacity 0.3s ease; /* Плавные переходы */
            transform: translateX(0); /* По умолчанию видима */
            z-index: 100; /* Над картой */
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
            opacity: 0; /* Для плавного исчезновения */
            transition: transform 0.3s ease, opacity 0.3s ease; /* Анимация */
        }


        /* Кнопка управления боковой панелью */
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 410px; /* Примерное размещение */
            z-index: 110; /* Над панелью */
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #7b9cc0, #2e4359); /* Градиент */
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease, background 0.2s ease;
        }

        .toggle-sidebar.collapsed {
            left: 20px; /* Расположение кнопки у края экрана */
        }

        .toggle-sidebar i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .toggle-sidebar.collapsed i {
            transform: rotate(180deg); /* Поворот стрелки */
        }

        .toggle-sidebar.collapsed {
            left: 0; /* Кнопка должна оставаться у края окна */
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 300px; /* Уменьшаем ширину */
            }

            .toggle-sidebar {
                left: 310px; /* Соответствующее положение кнопки */
            }

            .toggle-sidebar.collapsed {
                left: 20px;
            }
        }


        /* Легенда */
        .legend {
            margin-top: 20px;
            background: rgba(30, 50, 80, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .legend h4 {
            font-size: 18px;
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .legend ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 16px
        }


        .legend li {
            font-size: 14px;
            color: #e3f2fd;
            margin-bottom: 5px;
        }

        /* Кнопка управления сайдбаром */
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 400px; /* Или другое значение, зависящее от состояния боковой панели */
            z-index: 1000; /* Убедитесь, что значение выше остальных элементов */
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #7b9cc0, #2e4359);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease, background 0.2s ease;
        }


        .toggle-sidebar:hover {
            background: linear-gradient(135deg, #7c939e, #2a5975);
            transform: scale(1.1);
        }

        /* Таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
            color: #e3f2fd;
            background: rgba(20, 30, 50, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(40, 60, 90, 0.9);
            font-weight: bold;
            color: #fbc02d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            background: rgba(30, 50, 80, 0.8);
            color: #b3c7e6;
        }

        tr:nth-child(even) td {
            background: rgba(30, 50, 80, 0.7);
        }

        tr:hover td {
            background: rgba(50, 70, 100, 0.9);
            color: #ffffff;
            transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* График */
        .chart-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 380px;
            height: 280px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            padding: 15px;
            z-index: 5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            transform-origin: top right;
        }

        .chart-container.expanded {
            width: 600px;
            height: 400px;
        }

        .expand-chart {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #7c8f98, #296585);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
        }

        .expand-chart:hover {
            background: linear-gradient(135deg, #98a5ab, #356580);
            transform: scale(1.1);
        }

        .chart-container.minimized {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #7c8f98, #296585);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        .chart-container.minimized canvas,
        .chart-container.minimized button {
            display: none; /* Прячем содержимое */
        }


        /* Общие стили кнопок */
        .button-container {
            position: fixed;
            bottom: 60px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .action-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6d8692, #2e5d76);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, background 0.3s;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #7c939e, #2a5975);
            transform: scale(1.1);
        }

        .action-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .action-button i {
            pointer-events: none;
        }

        /* Настройка подсказок */
        .action-button[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 20;
            pointer-events: none;
        }

        .action-button[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
            z-index: 20;
        }

        .transparency-control {
            position: fixed;
            bottom: 40px; /* Над кнопками */
            right: 80px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px; /* Промежуток между иконкой и слайдером */
        }

        .transparency-control input[type="range"] {
            width: 150px; /* Установить ширину слайдера */
        }


        /* Кнопка "Во весь экран" */
        #fullscreen-toggle {
            position: fixed; /* Устанавливаем фиксированное позиционирование */
            bottom: 10px; /* Расположение кнопки снизу */
            right: 20px; /* Расположение кнопки справа */
            width: 50px; /* Размер кнопки */
            height: 50px;
            background: linear-gradient(135deg, #6d8692, #2e5d76); /* Градиент фона */
            color: #ffffff; /* Белый цвет иконки */
            border: none; /* Убираем границы */
            border-radius: 50%; /* Круглая кнопка */
            display: flex; /* Центровка содержимого */
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Указатель при наведении */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Тень для глубины */
            transition: transform 0.3s, background 0.3s; /* Анимация нажатия и наведения */
        }

        /* Эффект при наведении */
        #fullscreen-toggle:hover {
            background: linear-gradient(135deg, #7c939e, #2a5975); /* Изменение цвета при наведении */
            transform: scale(1.1); /* Увеличение кнопки */
        }

        /* Эффект при нажатии */
        #fullscreen-toggle:active {
            transform: scale(0.95); /* Уменьшение при клике */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Ослабление тени */
        }

        /* Иконка внутри кнопки */
        #fullscreen-toggle i {
            font-size: 20px; /* Размер иконки */
            pointer-events: none; /* Отключение событий мыши для иконки */
        }

    </style>
    
</head>

<body>
    <!-- Сайдбар -->
    <div class="sidebar" id="sidebar">
        <!-- Содержимое боковой панели -->
        <h3>Информация по району</h3>
        <p>Выберите район на карте, чтобы увидеть детальную информацию и графики.</p>
        <div class="info">
            <strong> </strong>
            <div id="district-info">
                <p>Нет данных. Выберите район для отображения информации.</p>
            </div>
        </div>
        <div class="legend">
            <h4>Легенда:</h4>
            <ul>
                <li><span style="color: #1a9641;">●</span> Высокий индекс QoL (0.75 - 1.00)</li>
                <li><span style="color: #fdae61;">●</span> Средний индекс QoL (0.50 - 0.74)</li>
                <li><span style="color: #d7191c;">●</span> Низкий индекс QoL (0.25 - 0.49)</li>
                <li><span style="color: #6c757d;">●</span> Очень низкий индекс QoL (0.00 - 0.24)</li>
            </ul>
        </div>
    </div>
    
    <!-- Кнопка управления -->
    <button class="toggle-sidebar" id="toggleSidebar" title="Скрыть панель">
        <i class="fas fa-chevron-left"></i>
    </button>
    

    <!-- Карта -->
    <div id="map" class="map-container"></div>

    <!-- График -->
    <div class="chart-container minimized" id="chartContainer">
        <i class="fas fa-chart-line"></i>
        <canvas id="qChart"></canvas>
        <button class="expand-chart" id="expandChart" title="Свернуть график">
            <i class="fas fa-compress"></i>
        </button>
    </div>

    <div class="controls">
        <div class="left-controls">
            <div class="transparency-control" title="Настроить прозрачность">
                <label for="opacity-slider">
                    <i class="fas fa-adjust"></i>
                </label>
                <input id="opacity-slider" type="range" min="0" max="1" step="0.1" value="0.7">
            </div>
        </div>
        <div class="right-controls">
            <button id="fullscreen-toggle" class="action-button" title="Во весь экран">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>

    <div class="button-container">
        <button id="showAll" class="action-button" title="Динамика всех районов">
            <i class="fas fa-chart-bar"></i>
        </button>
        <button id="showCurrentQ" class="action-button" title="Показать Q">
            <i class="fas fa-chart-line"></i>
        </button>
        <button id="showPreviousQ" class="action-button" title="Показать QoL_change">
            <i class="fas fa-history"></i>
        </button>
    </div>

    <script>
        // Устанавливаем токен Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWxpbmFjaCIsImEiOiJjbGlpcnZpaTgwMTZ4M2twaGo1NjRsNHhhIn0.9jw_R_D1i1nqOtaolld-dQ';
        
        // Создаем объект карты
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [76.945, 43.255], // Координаты центра
            zoom: 10
        });

        // URL для данных GeoJSON
        const geojsonUrl = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/qol_results_full_geo.geojson';

        let fullDataset = []; // Хранилище всех данных
        let popup; // Переменная для всплывающей подсказки
        let chartInstance; // Переменная для графика
        let showCurrent = true; // По умолчанию отображаем Q


        // Загружаем данные GeoJSON при загрузке карты
        map.on('load', async () => {
            try {
                // Запрашиваем данные GeoJSON
                const response = await fetch(geojsonUrl);
                const geojsonData = await response.json();

                // Обновляем данные и сохраняем их для использования
                fullDataset = geojsonData.features.map(feature => feature.properties);

                // Добавляем источник данных на карту
                addGeoJsonSource('districts', geojsonData);

                // Добавляем слои для отображения районов
                addDistrictLayers();

                // Устанавливаем события карты
                setupMapInteractions();

                console.log('Данные успешно обработаны и добавлены на карту:', geojsonData);
            } catch (error) {
                console.error('Ошибка загрузки GeoJSON:', error);
            }
        });

        // Функция для добавления источника GeoJSON
        function addGeoJsonSource(sourceId, geojsonData) {
            map.addSource(sourceId, {
                type: 'geojson',
                data: geojsonData,
            });
        }

        // Функция для добавления слоев на карту
        function addDistrictLayers() {
            // Добавляем слой заливки районов
            map.addLayer({
                id: 'districts-layer',
                type: 'fill',
                source: 'districts',
                paint: {
                    'fill-color': [
                        'step',
                        ['get', 'QoL'], 
                        '#6c757d', // Цвет для отсутствия данных
                        0.2, '#d7191c', // Очень низкий индекс
                        0.4, '#fdae61', // Средний индекс
                        0.6, '#a6d96a', // Выше среднего
                        0.8, '#1a9641'  // Высокий индекс
                    ],
                    'fill-opacity': 0.7, // Прозрачность по умолчанию
                },
            });

            // Добавляем слой контуров районов
            map.addLayer({
                id: 'districts-line',
                type: 'line',
                source: 'districts',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1,
                },
            });

            // Добавляем слой для подсветки районов при наведении
            map.addLayer({
                id: 'districts-highlight',
                type: 'fill',
                source: 'districts',
                paint: {
                    'fill-color': '#ffff00',
                    'fill-opacity': 0.8,
                },
                filter: ['==', 'district_name', ''], // Изначально пустой фильтр
            });

            // Устанавливаем начальную прозрачность из слайдера
            setInitialOpacity();
        }

        // Функция для установки прозрачности из значения слайдера
        function setInitialOpacity() {
            const opacitySlider = document.getElementById("opacity-slider");
            const initialOpacity = parseFloat(opacitySlider.value) || 0.7;
            map.setPaintProperty('districts-layer', 'fill-opacity', initialOpacity);

            // Обновляем прозрачность при изменении слайдера
            opacitySlider.addEventListener("input", (e) => {
                const opacity = parseFloat(e.target.value);
                map.setPaintProperty('districts-layer', 'fill-opacity', opacity);
            });
        }

        // Функция для обработки взаимодействий на карте
        function setupMapInteractions() {
            map.on('mousemove', 'districts-layer', handleHover);
            map.on('mouseleave', 'districts-layer', clearHover);
            map.on('click', 'districts-layer', handleClick);
        }

        // Функция для обработки наведения мыши
        function handleHover(e) {
            const properties = e.features[0].properties;

            const districtName = properties.orig_district_name || 'Неизвестный район';
            const currentValue = properties.QoL !== undefined ? properties.QoL.toFixed(2) : 'Нет данных';
            const change = properties.QoL_change !== null ? properties.QoL_change.toFixed(2) : 'Нет данных';

            // Дополнительные показатели
            const population = properties["orig_Численность населения"] || 'Нет данных';
            const housingInput = properties["orig_Ввод жилья"] || 'Нет данных';

            if (popup) popup.remove();
            popup = new mapboxgl.Popup({ closeButton: false })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <strong>${districtName}</strong><br>
                    <strong>Индекс качества жизни (QoL):</strong> ${currentValue}<br>
                    <strong>Изменение QoL:</strong> ${change}%<br>
                    <strong>Численность населения:</strong> ${population}<br>
                    <strong>Ввод жилья:</strong> ${housingInput} тыс. кв.м.<br>
                    <em>Для подробной информации кликните на район</em>
                `)
                .addTo(map);

            // Обновляем курсор
            map.getCanvas().style.cursor = 'pointer';

            // Подсветка района
            map.setFilter('districts-highlight', ['==', 'district_name', districtName]);
        }

        // Функция для сброса подсветки
        function clearHover() {
            map.setFilter('districts-highlight', ['==', 'district_name', '']);
            if (popup) popup.remove();
            map.getCanvas().style.cursor = '';
        }

        // Функция для обработки кликов на районы
        function handleClick(e) {
            const properties = e.features[0].properties;
            const districtName = properties.orig_district_name || 'Неизвестный район';

            // Список параметров для отображения
            const parameters = [
                'ВУЗы', 'Ввод жилья', 'Численность населения', 'Численность родившихся',
                'Численность умерших', 'Естественный прирост', 'Количество трудоустроенных',
                'Индекс физического объёма, по всей промышленности', 'Коэффицент брачности на 1000 человек',
                'Коэффицент естественного прироста на 1000 человек', 'Коэффицент младенческой смертности на 1000 человек',
                'Коэффицент рождаемости на 1000 человек', 'Миграция населения - сальдо'
            ];

            // Обновляем боковую панель
            document.getElementById('district-info').innerHTML = `
                <h3>${districtName}</h3>
                <table>
                    <tr><th>Параметр</th><th>Значение</th><th>Изменение</th></tr>
                    ${parameters.map(param => renderRow(param, properties)).join('')}
                </table>
            `;

            // Обновляем график для выбранного района
            const districtData = fullDataset.filter(item => item.orig_district_name === districtName);
            updateChart(districtData);

            // Раскрытие графика
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.classList.remove('minimized');
            chartContainer.classList.add('expanded');
        }

        // Функция для рендеринга строки таблицы
        function renderRow(name, properties) {
            const origKey = `orig_${name}`;
            const changeKey = `${name}_change`;

            const origValue = properties[origKey] !== undefined ? properties[origKey] : 'Нет данных';
            const changeValue = properties[changeKey] !== undefined ? properties[changeKey] : 'Нет данных';

            return `
                <tr>
                    <td>${name}</td>
                    <td>${origValue}</td>
                    <td>${changeValue}</td>
                </tr>
            `;
        }

        // Функция для переключения между QoL и QoL_change
        function setupParameterSwitching() {
            document.getElementById('showCurrentQ').addEventListener('click', () => {
                showCurrent = true;
                updateLayer();
            });

            document.getElementById('showPreviousQ').addEventListener('click', () => {
                showCurrent = false;
                updateLayer();
            });
        }

        // Обновление слоя с учётом выбранного параметра
        function updateLayer() {
            const property = showCurrent ? 'QoL' : 'QoL_change';
            map.setPaintProperty('districts-layer', 'fill-color', [
                'step',
                ['get', property],
                '#6c757d', // Цвет для отсутствия данных
                0.2, '#d7191c',
                0.4, '#fdae61',
                0.6, '#a6d96a',
                0.8, '#1a9641'
            ]);
        }


        // Полноэкранный режим
        function toggleFullScreen() {
            const fullscreenButton = document.querySelector('#fullscreen-toggle i'); // Иконка кнопки
            const fullscreenButtonContainer = document.querySelector('#fullscreen-toggle'); // Контейнер кнопки

            // Кросс-браузерные методы для проверки и запуска полноэкранного режима
            const element = document.documentElement;
            const requestFullscreen = element.requestFullscreen || element.webkitRequestFullscreen || element.mozRequestFullScreen || element.msRequestFullscreen;
            const exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Входим в полноэкранный режим
                if (requestFullscreen) {
                    requestFullscreen.call(element)
                        .then(() => {
                            updateFullscreenButton(true); // Обновляем кнопку
                            console.log('Вошли в полноэкранный режим');
                        })
                        .catch((err) => {
                            console.error(`Ошибка при входе в полноэкранный режим: ${err.message}`);
                        });
                }
            } else {
                // Выходим из полноэкранного режима
                if (exitFullscreen) {
                    exitFullscreen.call(document)
                        .then(() => {
                            updateFullscreenButton(false); // Обновляем кнопку
                            console.log('Вышли из полноэкранного режима');
                        })
                        .catch((err) => {
                            console.error(`Ошибка при выходе из полноэкранного режима: ${err.message}`);
                        });
                }
            }

            // Вспомогательная функция для обновления иконки и подсказки кнопки
            function updateFullscreenButton(isFullscreen) {
                if (isFullscreen) {
                    fullscreenButton.classList.remove('fa-expand');
                    fullscreenButton.classList.add('fa-compress');
                    fullscreenButtonContainer.setAttribute('title', 'Свернуть экран');
                } else {
                    fullscreenButton.classList.remove('fa-compress');
                    fullscreenButton.classList.add('fa-expand');
                    fullscreenButtonContainer.setAttribute('title', 'Во весь экран');
                }
            }
        }



        function updateSidebar(districtData) {
            // Проверяем, есть ли данные для выбранного района
            if (!districtData.length) {
                console.error('Данные для выбранного района отсутствуют.');
                document.getElementById('district-info').innerHTML = `<p>Нет данных для выбранного района.</p>`;
                return;
            }

            // Ищем последнюю запись для района
            const latestQuarter = districtData.reduce((latest, current) => {
                const latestDate = new Date(latest.orig_indicator_date || '1900-01-01');
                const currentDate = new Date(current.orig_indicator_date || '1900-01-01');
                return currentDate > latestDate ? current : latest;
            });

            // Обновляем панель с данными
            document.getElementById('district-info').innerHTML = `
                <h3>${latestQuarter.orig_district_name || 'Нет данных'}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr>
                        <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Параметр</th>
                        <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Значение</th>
                    </tr>
                    <tr><td style="padding: 8px;">Дата</td><td style="padding: 8px;">${latestQuarter.orig_indicator_date || 'Нет данных'}</td></tr>
                    <tr><td style="padding: 8px;">Индекс Q</td><td style="padding: 8px;">${latestQuarter.QoL !== undefined ? latestQuarter.QoL.toFixed(2) : 'Нет данных'}</td></tr>
                    <tr><td style="padding: 8px;">Изменение Q (%)</td><td style="padding: 8px;">${latestQuarter.QoL_change !== undefined ? latestQuarter.QoL_change.toFixed(2) + '%' : 'Нет данных'}</td></tr>
                    <tr><td style="padding: 8px;">Численность населения</td><td style="padding: 8px;">${latestQuarter["orig_Численность населения"] || 'Нет данных'} чел.</td></tr>
                    <tr><td style="padding: 8px;">Численность родившихся</td><td style="padding: 8px;">${latestQuarter["orig_Численность родившихся"] || 'Нет данных'} чел.</td></tr>
                    <tr><td style="padding: 8px;">Численность умерших</td><td style="padding: 8px;">${latestQuarter["orig_Численность умерших"] || 'Нет данных'} чел.</td></tr>
                    <tr><td style="padding: 8px;">Естественный прирост</td><td style="padding: 8px;">${latestQuarter["orig_Естественный прирост"] || 'Нет данных'} чел.</td></tr>
                    <tr><td style="padding: 8px;">Среднемесячная зарплата</td><td style="padding: 8px;">${latestQuarter["orig_Среднемесячная зарплата по организационно-правовым формам"] || 'Нет данных'} тг.</td></tr>
                    <tr><td style="padding: 8px;">Объём промышленной продукции</td><td style="padding: 8px;">${latestQuarter["orig_Объём промышленной продукции по всей промышленности"] || 'Нет данных'} млн тг.</td></tr>
                    <tr><td style="padding: 8px;">Ввод жилья</td><td style="padding: 8px;">${latestQuarter["orig_Ввод жилья"] || 'Нет данных'} тыс. кв.м.</td></tr>
                </table>
            `;
        }


        // Обновление графика
        function updateChart(data) {
            // Проверяем наличие данных
            if (!data || data.length === 0) {
                console.warn('Нет данных для отображения на графике.');
                return;
            }

            // Подготовка данных для графика
            const chartData = data
                .filter(d => d.indicator_date && d.QoL !== undefined) // Фильтрация по QoL
                .sort((a, b) => new Date(a.indicator_date) - new Date(b.indicator_date))
                .map(d => ({
                    date: d.indicator_date, // Дата
                    value: d.QoL,           // Индекс качества жизни
                    delta: d.QoL_change || 0 // Изменение индекса
                }));

            const labels = chartData.map(item => item.date);    // Метки на оси X
            const values = chartData.map(item => item.value);   // Значения QoL
            const deltas = chartData.map(item => item.delta);   // Изменение QoL

            // Цвета для точек графика QoL
            const pointColorsQoL = values.map(value => {
                if (value < 0.2) return '#d7191c'; // Низкий индекс
                if (value < 0.4) return '#fdae61'; // Средний индекс
                if (value < 0.6) return '#a6d96a'; // Выше среднего
                return '#1a9641';                 // Высокий индекс
            });

            // Цвета для изменения QoL
            const pointColorsDelta = deltas.map(delta => (delta >= 0 ? '#1a9641' : '#d7191c'));

            const ctx = document.getElementById('qChart').getContext('2d');

            // Если график уже создан, обновляем его
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.data.datasets[0].pointBackgroundColor = pointColorsQoL;
                chartInstance.data.datasets[1].data = deltas;
                chartInstance.data.datasets[1].pointBackgroundColor = pointColorsDelta;
                chartInstance.update();
            } else {
                // Создаем новый график, если его ещё нет
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Индекс Q',
                                data: values,
                                borderColor: '#1a9641',
                                backgroundColor: 'rgba(26, 150, 65, 0.1)',
                                pointBackgroundColor: pointColorsQoL,
                                pointRadius: 5,
                                tension: 0.3
                            },
                            {
                                label: 'Изменение Q',
                                data: deltas,
                                borderColor: '#ff7f0e',
                                backgroundColor: 'rgba(255, 127, 14, 0.1)',
                                pointBackgroundColor: pointColorsDelta,
                                pointRadius: 4,
                                borderDash: [5, 5],
                                tension: 0.3,
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw.toFixed(2);
                                        return context.dataset.label === 'Индекс Q' 
                                            ? `Индекс Q: ${value}` 
                                            : `Изменение Q: ${value}%`;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Динамика индекса качества жизни'
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Квартал' },
                                ticks: { autoSkip: true, maxRotation: 45 }
                            },
                            y: {
                                title: { display: true, text: 'Индекс Q' },
                                beginAtZero: true
                            },
                            y2: {
                                title: { display: true, text: 'Изменение Q (%)' },
                                beginAtZero: true,
                                position: 'right',
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
        }


        document.addEventListener("DOMContentLoaded", () => {
            // Элементы управления
            const fullscreenToggle = document.getElementById("fullscreen-toggle");
            const showCurrentQoL = document.getElementById("showCurrentQ");
            const showPreviousQoL = document.getElementById("showPreviousQ");
            const opacitySlider = document.getElementById("opacity-slider");
            const sidebar = document.getElementById("sidebar");
            const toggleSidebarButton = document.getElementById("toggleSidebar");
            const chartContainer = document.getElementById("chartContainer");

            // Состояния
            let isFullscreen = false;
            let showQMode = "current"; // Режим отображения (current/previous)

            // Полноэкранный режим
            fullscreenToggle.addEventListener("click", () => {
                const mapContainer = document.getElementById("map");
                if (!isFullscreen) {
                    mapContainer.requestFullscreen()
                        .then(() => {
                            fullscreenToggle.innerHTML = `<i class="fas fa-compress"></i>`;
                            fullscreenToggle.title = "Свернуть";
                        })
                        .catch(err => console.error(`Ошибка при входе в полноэкранный режим: ${err.message}`));
                } else {
                    document.exitFullscreen()
                        .then(() => {
                            fullscreenToggle.innerHTML = `<i class="fas fa-expand"></i>`;
                            fullscreenToggle.title = "Во весь экран";
                        })
                        .catch(err => console.error(`Ошибка при выходе из полноэкранного режима: ${err.message}`));
                }
                isFullscreen = !isFullscreen;
            });

            // Переключение режима отображения Q
            const updateLayerColor = () => {
                const property = showQMode === "current" ? "Q" : "QoL_change";
                map.setPaintProperty("districts-layer", "fill-color", [
                    "step",
                    ["get", property],
                    "#6c757d",
                    0.3, "#d7191c",
                    0.40, "#fdae61",
                    0.5, "#1a9641"
                ]);
            };

            const toggleShowQMode = (mode) => {
                showQMode = mode;
                updateLayerColor();
            };

            showCurrentQ.addEventListener("click", () => toggleShowQMode("current"));
            showPreviousQ.addEventListener("click", () => toggleShowQMode("previous"));

            // Изменение прозрачности слоя
            opacitySlider.addEventListener("input", (e) => {
                const opacity = parseFloat(e.target.value);
                map.setPaintProperty("districts-layer", "fill-opacity", opacity);
            });

            // Функция для обработки кнопки боковой панели
            const handleSidebarToggle = () => {
                const isCollapsed = sidebar.classList.contains("collapsed");

                sidebar.classList.toggle("collapsed", !isCollapsed);
                toggleSidebarButton.classList.toggle("collapsed", !isCollapsed);
                toggleSidebarButton.style.left = isCollapsed ? "400px" : "20px";

                const icon = toggleSidebarButton.querySelector("i");
                icon.classList.toggle("fa-chevron-left", isCollapsed);
                icon.classList.toggle("fa-chevron-right", !isCollapsed);
            };

            // Логика для боковой панели
            toggleSidebarButton.addEventListener("click", handleSidebarToggle);

            // Логика для графика
            const toggleChartState = () => {
                const isMinimized = chartContainer.classList.contains("minimized");
                chartContainer.classList.toggle("minimized", !isMinimized);
                chartContainer.classList.toggle("expanded", isMinimized);

                // Обновляем размеры графика
                const canvas = document.getElementById("qChart");
                if (chartContainer.classList.contains("expanded")) {
                    canvas.style.width = "100%";
                    canvas.style.height = "100%";
                } else {
                    canvas.style.width = "380px";
                    canvas.style.height = "280px";
                }

                // Перерисовываем график, если он существует
                if (typeof chartInstance !== "undefined" && chartInstance) {
                    chartInstance.resize();
                }
            };

            chartContainer.addEventListener("click", toggleChartState);

            // Обновление графика для всех данных
            document.getElementById("showAll").addEventListener("click", () => {
                updateChart();
            });
        });

    </script>
</body>

</html>
