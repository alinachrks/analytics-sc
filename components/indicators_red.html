<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Индекс качества жизни</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <!-- Подключение стилей и скриптов -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax для LaTeX -->
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>


    <style>
        /* Основной стиль */
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #f3f4f6, #e2e5ea);
        }

        /* Карта */
        #map {
            flex: 1;
            width: 100%; /* Убедиться в заполнении ширины */
            height: 100%; /* Убедиться в заполнении высоты */
        }

        /* Сайдбар */
        .sidebar {
            width: 400px;
            max-width: 80%; /* Для мобильных устройств */
            padding: 12px;
            background: rgba(20, 30, 50, 0.95);
            color: #ffffff;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            height: 100%; /* Полная высота */
            position: fixed; /* Фиксация на экране */
            left: 0;
            top: 0;
            transition: transform 0.3s ease, opacity 0.3s ease; /* Плавные переходы */
            transform: translateX(0); /* По умолчанию видима */
            z-index: 100; /* Над картой */
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
            opacity: 0; /* Для плавного исчезновения */
            transition: transform 0.3s ease, opacity 0.3s ease; /* Анимация */
        }


        /* Кнопка управления боковой панелью */
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 410px; /* Примерное размещение */
            z-index: 110; /* Над панелью */
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #7b9cc0, #2e4359); /* Градиент */
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease, background 0.2s ease;
        }

        .toggle-sidebar.collapsed {
            left: 20px; /* Расположение кнопки у края экрана */
        }

        .toggle-sidebar i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .toggle-sidebar.collapsed i {
            transform: rotate(180deg); /* Поворот стрелки */
        }

        .toggle-sidebar.collapsed {
            left: 0; /* Кнопка должна оставаться у края окна */
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 300px; /* Уменьшаем ширину */
            }

            .toggle-sidebar {
                left: 310px; /* Соответствующее положение кнопки */
            }

            .toggle-sidebar.collapsed {
                left: 20px;
            }
        }


        /* Легенда */
        .legend {
            margin-top: 20px;
            background: rgba(30, 50, 80, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .legend h4 {
            font-size: 18px;
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .legend ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 16px
        }


        .legend li {
            font-size: 14px;
            color: #e3f2fd;
            margin-bottom: 5px;
        }

        /* Кнопка управления сайдбаром */
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 400px; /* Или другое значение, зависящее от состояния боковой панели */
            z-index: 1000; /* Убедитесь, что значение выше остальных элементов */
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #7b9cc0, #2e4359);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease, background 0.2s ease;
        }


        .toggle-sidebar:hover {
            background: linear-gradient(135deg, #7c939e, #2a5975);
            transform: scale(1.1);
        }

        /* Таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
            color: #e3f2fd;
            background: rgba(20, 30, 50, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(40, 60, 90, 0.9);
            font-weight: bold;
            color: #fbc02d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            background: rgba(30, 50, 80, 0.8);
            color: #b3c7e6;
        }

        tr:nth-child(even) td {
            background: rgba(30, 50, 80, 0.7);
        }

        tr:hover td {
            background: rgba(50, 70, 100, 0.9);
            color: #ffffff;
            transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* График */
        .chart-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 380px;
            height: 280px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            padding: 15px;
            z-index: 5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease-in-out;
            transform-origin: top right;
        }

        .chart-container.expanded {
            width: 600px;
            height: 400px;
        }

        .expand-chart {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #7c8f98, #296585);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
        }

        .expand-chart:hover {
            background: linear-gradient(135deg, #98a5ab, #356580);
            transform: scale(1.1);
        }

        .chart-container.minimized {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #7c8f98, #296585);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        .chart-container.minimized canvas,
        .chart-container.minimized button {
            display: none; /* Прячем содержимое */
        }

        /* Контейнер кнопок внутри графика */
        .chart-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px; /* Отступ между кнопками */
        }

        /* Исправленный стиль для кнопок */
        .chart-controls button {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #7c8f98, #296585);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .chart-controls button:hover {
            background: linear-gradient(135deg, #98a5ab, #356580);
            transform: scale(1.1);
        }

        .chart-controls button:active {
            transform: scale(0.9);
        }


        /* Общие стили кнопок */
        /* Контейнер для кнопок */
        .button-container {
            position: fixed;
            bottom: 20px; /* Прижимаем к низу */
            right: 20px; /* Справа */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* Отступ между кнопками */
            z-index: 1000;
            background: rgba(20, 30, 50, 0.85);
            border-radius: 12px;
            padding: 10px 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Ряды кнопок */
        .button-row {
            display: flex;
            justify-content: center;
            gap: 6px; /* Отступ между кнопками в ряду */
        }

        /* Стили кнопок */
        .action-button {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #6d8692, #2e5d76);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .action-button:hover {
            background: linear-gradient(135deg, #7c939e, #2a5975);
            transform: scale(1.1);
        }

        .action-button:active {
            transform: scale(0.95);
        }

        /* Горизонтальный слайдер */
        .transparency-slider-horizontal {
            margin-top: 10px;
            width: 80%; /* Растягиваем по ширине */
        }

        .transparency-slider-horizontal input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d3d3d3;
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        .transparency-slider-horizontal input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #2e5d76;
            border: 2px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .transparency-slider-horizontal input[type="range"]:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }



        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 20px; /* Отступ сверху */
            right: 20px; /* Прижимаем к правому краю */
            width: 350px; /* Фиксированная ширина */
            height: auto; /* Высота зависит от контента */
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background: linear-gradient(135deg, #f9fafb, #ffffff);
            color: #333;
            margin: 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: -4px -4px 10px rgba(0, 0, 0, 0.3);
            max-height: 90vh; /* Ограничение высоты */
            overflow-y: auto; /* Прокрутка при необходимости */
        }


        /* Заголовок и текст */
        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1a76d2;
            text-align: center;
        }

        .modal-content h4 {
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            display: inline-block;
        }

        .modal-content p, .modal-content ul {
            font-size: 1rem;
            line-height: 1.6;
            color: #555;
        }

        .modal-content ul {
            padding-left: 20px;
        }

        .modal-content ul li {
            margin: 10px 0;
            font-weight: 500;
        }

        .close-modal {
            color: #555;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease-in-out;
        }

        .close-modal:hover {
            color: #d32f2f;
        }

        /* Анимация появления */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }




    </style>
    
</head>

<body>
    <!-- Сайдбар -->
    <div class="sidebar" id="sidebar">
        <!-- Содержимое боковой панели -->
        <h3>Информация по району</h3>
        <p>Выберите район на карте, чтобы увидеть детальную информацию и графики.</p>
        <div class="info">
            <strong> </strong>
            <div id="district-info">
                <p>Нет данных. Выберите район для отображения информации.</p>
            </div>
        </div>
        <div class="legend">
            <h4>Легенда:</h4>
            <ul>
                <li><span style="color: #1a9641;">●</span> Высокий индекс QoL (0.5 - 1.00)</li>
                <li><span style="color: #a6d96a;">●</span> Выше среднего индекс QoL (0.3 - 0.49)</li>
                <li><span style="color: #fdae61;">●</span> Средний индекс QoL (0.2 - 0.29)</li>
                <li><span style="color: #d7191c;">●</span> Очень низкий индекс QoL (0.1 - 0.19)</li>
                <li><span style="color: #6c757d;">●</span> Нет данных или нулевой индекс</li>
            </ul>            
        </div>
    </div>
    
    <!-- Кнопка управления -->
    <button class="toggle-sidebar" id="toggleSidebar" title="Скрыть панель">
        <i class="fas fa-chevron-left"></i>
    </button>
    

    <!-- Карта -->
    <div id="map" class="map-container"></div>

    <!-- Контейнер для графиков -->
    <div class="charts-wrapper">
        
        <!-- График QoL -->
        <div class="chart-container minimized" id="chartContainer">
            <canvas id="qChart"></canvas>
            <div class="chart-controls">
                <button class="toggle-chart" id="expandChart" title="Развернуть график">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>

        <!-- График QoL по районам -->
        <div class="chart-container minimized" id="multiDistrictChartContainer">
            <canvas id="multiDistrictChart"></canvas>
            <div class="chart-controls">
                <button class="toggle-chart" id="toggleMultiDistrictFullscreen" title="Во весь экран">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
        

        <!-- Кнопки переключения графиков -->
        <div class="chart-buttons">
            <button id="showSingleDistrictChart" class="action-button" title="График QoL для района">
                <i class="fas fa-chart-line"></i>
            </button>
            <button id="showMultiDistrictChart" class="action-button" title="График QoL по районам">
                <i class="fas fa-chart-area"></i>
            </button>
        </div>
        

    </div>


    <div class="button-container">
        <div class="button-row">
            <button id="showCurrentQ" class="action-button" title="Показать текущий QoL">
                <i class="fas fa-chart-line"></i>
            </button>
            <button id="showPreviousQ" class="action-button" title="Показать изменение QoL">
                <i class="fas fa-history"></i>
            </button>
        </div>
        <div class="button-row">
            <button id="showMethodology" class="action-button" title="Методика расчёта QoL">
                <i class="fas fa-info-circle"></i>
            </button>
            <button id="fullscreen-toggle" class="action-button" title="Во весь экран">
                <i class="fas fa-expand"></i>
            </button>
        </div>
        <!-- Вертикальный слайдер для прозрачности -->
        <div class="transparency-slider-horizontal">
            <input id="opacity-slider" type="range" min="0" max="1" step="0.1" value="0.7" title="Прозрачность">
        </div>
    </div>
    
    


    <!-- Модальное окно для методики -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Методика расчёта индекса качества жизни (QoL)</h3>
            
            <p>
                Индекс качества жизни (QoL) агрегирует несколько показателей в ключевые категории:
            </p>
            <ul>
                <li><strong>Демография:</strong> рождаемость, смертность, миграция.</li>
                <li><strong>Экономика:</strong> уровень зарплат, количество предприятий.</li>
                <li><strong>Жилищные условия:</strong> ввод жилья, количество квартир.</li>
                <li><strong>Безопасность:</strong> показатели смертности от различных причин.</li>
            </ul>
    
            <h4>Формула расчёта:</h4>
            <p style="text-align: center;">
                \( Q = w_D \cdot D + w_E \cdot E + w_H \cdot H + w_S \cdot S + w_{SS} \cdot SS \)
            </p>
            <p>
                где:
                <ul>
                    <li>\( Q \) — итоговый индекс качества жизни.</li>
                    <li>\( D, E, H, S, SS \) — категории показателей.</li>
                    <li>\( w \) — веса категорий (например, \( w_D = 0.25 \)).</li>
                </ul>
            </p>
    
            <h4>Нормализация данных:</h4>
            <p style="text-align: center;">
                \( x_{\text{norm}} = \frac{x - x_{\text{min}}}{x_{\text{max}} - x_{\text{min}}} \)
            </p>
            <p>
                где \( x \) — значение показателя, \( x_{\text{min}}, x_{\text{max}} \) — минимальное и максимальное значения.
            </p>
        </div>
    </div>
    

    <script>
        // Устанавливаем токен Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWxpbmFjaCIsImEiOiJjbGlpcnZpaTgwMTZ4M2twaGo1NjRsNHhhIn0.9jw_R_D1i1nqOtaolld-dQ';
        
        // Создаем объект карты
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [76.945, 43.255], // Координаты центра
            zoom: 10
        });

        // URL для данных GeoJSON
        const geojsonUrl = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/qol_results_full_geo%20(2).geojson';

        let fullDataset = []; // Хранилище всех данных
        let popup; // Переменная для всплывающей подсказки
        let chartInstance; // Переменная для графика
        let showCurrent = true; // По умолчанию отображаем Q


        // Загружаем данные GeoJSON при загрузке карты
        map.on('load', async () => {
            try {
                // Запрашиваем данные GeoJSON
                const response = await fetch(geojsonUrl);
                const geojsonData = await response.json();

                // Обновляем данные и сохраняем их для использования
                fullDataset = geojsonData.features.map(feature => feature.properties);

                // Добавляем источник данных на карту
                addGeoJsonSource('districts', geojsonData);

                // Добавляем слои для отображения районов
                addDistrictLayers();

                // Устанавливаем события карты
                setupMapInteractions();

                console.log('Данные успешно обработаны и добавлены на карту:', geojsonData);
            } catch (error) {
                console.error('Ошибка загрузки GeoJSON:', error);
            }
        });

        // Функция для добавления источника GeoJSON
        function addGeoJsonSource(sourceId, geojsonData) {
            map.addSource(sourceId, {
                type: 'geojson',
                data: geojsonData,
            });
        }

        // Функция для добавления слоев на карту
        function addDistrictLayers() {
            // Добавляем слой заливки районов
            map.addLayer({
                id: 'districts-layer',
                type: 'fill',
                source: 'districts',
                paint: {
                    'fill-color': [
                        'step',
                        ['get', 'QoL'], 
                        '#6c757d', // Цвет для отсутствия данных
                        0.1, '#d7191c', // Очень низкий индекс
                        0.2, '#fdae61', // Средний индекс
                        0.3, '#a6d96a', // Выше среднего
                        0.5, '#1a9641'  // Высокий индекс
                    ],
                    'fill-opacity': 0.7, // Прозрачность по умолчанию
                },
            });

            // Добавляем слой контуров районов
            map.addLayer({
                id: 'districts-line',
                type: 'line',
                source: 'districts',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1,
                },
            });

            // Добавляем слой для подсветки районов при наведении
            map.addLayer({
                id: 'districts-highlight',
                type: 'fill',
                source: 'districts',
                paint: {
                    'fill-color': '#ffff00',
                    'fill-opacity': 0.8,
                },
                filter: ['==', 'district_name', ''], // Изначально пустой фильтр
            });

            // Устанавливаем начальную прозрачность из слайдера
            setInitialOpacity();
        }

        // Функция для установки прозрачности из значения слайдера
        function setInitialOpacity() {
            const opacitySlider = document.getElementById("opacity-slider");
            const initialOpacity = parseFloat(opacitySlider.value) || 0.7;
            map.setPaintProperty('districts-layer', 'fill-opacity', initialOpacity);

            // Обновляем прозрачность при изменении слайдера
            opacitySlider.addEventListener("input", (e) => {
                const opacity = parseFloat(e.target.value);
                map.setPaintProperty('districts-layer', 'fill-opacity', opacity);
            });
        }

        // Функция для обработки взаимодействий на карте
        function setupMapInteractions() {
            map.on('mousemove', 'districts-layer', handleHover);
            map.on('mouseleave', 'districts-layer', clearHover);
            map.on('click', 'districts-layer', handleClick);
        }

        // Функция для обработки наведения мыши
        function handleHover(e) {
            const properties = e.features[0].properties;

            const districtName = properties.orig_district_name || 'Неизвестный район';
            const currentValue = properties.QoL !== undefined ? properties.QoL.toFixed(2) : 'Нет данных';
            const change = properties.QoL_change !== null ? properties.QoL_change.toFixed(2) : 'Нет данных';

            // Дополнительные показатели
            const population = properties["orig_Численность населения"] || 'Нет данных';
            const housingInput = properties["orig_Ввод жилья"] || 'Нет данных';

            if (popup) popup.remove();
            popup = new mapboxgl.Popup({ closeButton: false })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <strong>${districtName}</strong><br>
                    <strong>Индекс качества жизни (QoL):</strong> ${currentValue}<br>
                    <strong>Изменение QoL:</strong> ${change}%<br>
                    <strong>Численность населения:</strong> ${population}<br>
                    <strong>Ввод жилья:</strong> ${housingInput} тыс. кв.м.<br>
                    <em>Для подробной информации кликните на район</em>
                `)
                .addTo(map);

            // Обновляем курсор
            map.getCanvas().style.cursor = 'pointer';

            // Подсветка района
            map.setFilter('districts-highlight', ['==', 'district_name', districtName]);
        }

        // Функция для сброса подсветки
        function clearHover() {
            map.setFilter('districts-highlight', ['==', 'district_name', '']);
            if (popup) popup.remove();
            map.getCanvas().style.cursor = '';
        }

        // Функция для обработки кликов на районы
        function handleClick(e) {
            const properties = e.features[0].properties;
            const districtName = properties.orig_district_name || 'Неизвестный район';

            // Список параметров для отображения
            const parameters = [
                // 📊 Демография
                "Численность населения", "Численность родившихся", "Численность умерших",
                "Естественный прирост", "Коэффицент рождаемости на 1000 человек", "Коэффицент смертности на 1000 человек",
                "Коэффицент естественного прироста на 1000 человек", "Миграция населения - выбыло", 
                "Миграция населения - прибыло", "Миграция населения - сальдо",

                // 🏗 Инфраструктура и жильё
                "Ввод жилья", "Многоквартирные жилые дома", "Индивидуальные жилые дома",
                "Количество квартир - многоквартирные дома",

                // 💰 Экономика
                "Количество трудоустроенных", "Среднемесячная зарплата по организационно-правовым формам",
                "Индекс физического объёма, по всей промышленности", "Объём промышленной продукции по всей промышленности",
                "Всего действующих крупных и средних промышленных предприятий", "Количество зарегистрированных крупных предприятий",
                "Количество зарегистрированных малых предприятий", "Количество зарегистрированных средних предприятий",
                "Количество зарегистрированных субъектов всего по району", "Количество действующих субъектов всего по району",
                "Действующие зарегистрированные субъекты малого предпринимательства",
                "Всего зарегистрированных субъектов малого предпринимательства (юрид. и физ. лица)",
                "Количество действующих государственных предприятий", "Количество действующих частных предприятий",
                "Количество действующих иностранных предприятий",

                // 🚨 Безопасность и смертность
                "Коэффицент младенческой смертности на 1000 человек", "Умершие от несчастных случаев, отравлений и травм",
                "Умершие от самоубийств", "Умершие от болезней органов дыхания", "Умершие от болезней органов пищеварения",
                "Умершие от болезней системы кровообращения", "Умершие от гипертонической болезни",
                "Умершие от гриппа, ОРЗ и пневмонии", "Умершие от дорожно-транспортных происшествий",
                "Умершие от злокачественных новообразований", "Умершие от инфекционных и паразитарных болезней",
                "Умершие от ишемической болезни сердца", "Умершие от новообразований", "Умершие от острого инфаркта миокарда",
                "Умершие от стенокардии", "Умершие от сосудистого поражения мозга", "Умершие от убийств",

                // 💡 Социальное благополучие
                "Число браков", "Число разводов", "Коэффицент брачности на 1000 человек",
                "Коэффицент разводимости на 1000 человек",

                // 🎓 Образование
        
            ];


            // Обновляем боковую панель
            document.getElementById('district-info').innerHTML = `
                <h3>${districtName}</h3>
                <table>
                    <tr><th>Параметр</th><th>Значение</th><th>Изменение</th></tr>
                    ${parameters.map(param => renderRow(param, properties)).join('')}
                </table>
            `;

            // Обновляем график для выбранного района
            const districtData = fullDataset.filter(item => item.orig_district_name === districtName);
            updateChart(districtData);

            // Раскрытие графика
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.classList.remove('minimized');
            chartContainer.classList.add('expanded');
        }

        // Функция для рендеринга строки таблицы
        function renderRow(name, properties) {
            const origKey = `orig_${name}`;
            const changeKey = `${name}_change`;

            const origValue = properties[origKey] !== undefined ? properties[origKey] : 'Нет данных';
            const changeValue = properties[changeKey] !== undefined ? properties[changeKey] : 'Нет данных';

            return `
                <tr>
                    <td>${name}</td>
                    <td>${origValue}</td>
                    <td>${changeValue}</td>
                </tr>
            `;
        }

        // Функция для переключения между QoL и QoL_change
        function setupParameterSwitching() {
            document.getElementById('showCurrentQ').addEventListener('click', () => {
                showCurrent = true;
                updateLayer();
            });

            document.getElementById('showPreviousQ').addEventListener('click', () => {
                showCurrent = false;
                updateLayer();
            });
        }

        // Обновление слоя с учётом выбранного параметра
        function updateLayer() {
            const property = showCurrent ? 'QoL' : 'QoL_change';
            map.setPaintProperty('districts-layer', 'fill-color', [
                'step',
                ['get', property],
                '#6c757d', // Цвет для отсутствия данных
                0.1, '#d7191c',
                0.2, '#fdae61',
                0.3, '#a6d96a',
                0.5, '#1a9641'
            ]);
        }


        // Полноэкранный режим
        function toggleFullScreen() {
            const fullscreenButton = document.querySelector('#fullscreen-toggle i'); // Иконка кнопки
            const fullscreenButtonContainer = document.querySelector('#fullscreen-toggle'); // Контейнер кнопки

            // Кросс-браузерные методы для проверки и запуска полноэкранного режима
            const element = document.documentElement;
            const requestFullscreen = element.requestFullscreen || element.webkitRequestFullscreen || element.mozRequestFullScreen || element.msRequestFullscreen;
            const exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Входим в полноэкранный режим
                if (requestFullscreen) {
                    requestFullscreen.call(element)
                        .then(() => {
                            updateFullscreenButton(true); // Обновляем кнопку
                            console.log('Вошли в полноэкранный режим');
                        })
                        .catch((err) => {
                            console.error(`Ошибка при входе в полноэкранный режим: ${err.message}`);
                        });
                }
            } else {
                // Выходим из полноэкранного режима
                if (exitFullscreen) {
                    exitFullscreen.call(document)
                        .then(() => {
                            updateFullscreenButton(false); // Обновляем кнопку
                            console.log('Вышли из полноэкранного режима');
                        })
                        .catch((err) => {
                            console.error(`Ошибка при выходе из полноэкранного режима: ${err.message}`);
                        });
                }
            }

            // Вспомогательная функция для обновления иконки и подсказки кнопки
            function updateFullscreenButton(isFullscreen) {
                if (isFullscreen) {
                    fullscreenButton.classList.remove('fa-expand');
                    fullscreenButton.classList.add('fa-compress');
                    fullscreenButtonContainer.setAttribute('title', 'Свернуть экран');
                } else {
                    fullscreenButton.classList.remove('fa-compress');
                    fullscreenButton.classList.add('fa-expand');
                    fullscreenButtonContainer.setAttribute('title', 'Во весь экран');
                }
            }
        }


        // Обновляем боковой панели
        function updateSidebar(districtData) {
            const sidebarContent = document.getElementById('district-info');

            // Проверка на наличие данных
            if (!districtData || districtData.length === 0) {
                console.warn('Нет данных для выбранного района.');
                sidebarContent.innerHTML = `<p>Нет данных для выбранного района.</p>`;
                return;
            }

            // Получаем данные за последний период
            const latestQuarter = districtData.reduce((latest, current) => {
                const latestDate = new Date(latest.orig_indicator_date || '1900-01-01');
                const currentDate = new Date(current.orig_indicator_date || '1900-01-01');
                return currentDate > latestDate ? current : latest;
            });

            console.log("Данные latestQuarter:", latestQuarter);
            console.log("Доступные ключи:", Object.keys(latestQuarter)); // Проверяем доступные ключи

            const parameters = [
                // 📊 Демография
                { label: "Численность населения", key: "orig_Численность населения" },
                { label: "Численность родившихся", key: "orig_Численность родившихся" },
                { label: "Численность умерших", key: "orig_Численность умерших" },
                { label: "Естественный прирост", key: "orig_Естественный прирост" },
                { label: "Коэффициент рождаемости на 1000 человек", key: "orig_Коэффицент рождаемости на 1000 человек" },
                { label: "Коэффициент смертности на 1000 человек", key: "orig_Коэффицент смертности на 1000 человек" },
                { label: "Коэффициент естественного прироста на 1000 человек", key: "orig_Коэффицент естественного прироста на 1000 человек" },
                { label: "Миграция населения - выбыло", key: "orig_Миграция населения - выбыло" },
                { label: "Миграция населения - прибыло", key: "orig_Миграция населения - прибыло" },
                { label: "Миграция населения - сальдо", key: "orig_Миграция населения - сальдо" },

                // 🏗 Инфраструктура и жильё
                { label: "Ввод жилья", key: "orig_Ввод жилья" },
                { label: "Многоквартирные жилые дома", key: "orig_Многоквартирные жилые дома" },
                { label: "Индивидуальные жилые дома", key: "orig_Индивидуальные жилые дома" },
                { label: "Количество квартир - многоквартирные дома", key: "orig_Количество квартир - многоквартирные дома" },

                // 💰 Экономика
                { label: "Количество трудоустроенных", key: "orig_Количество трудоустроенных" },
                { label: "Среднемесячная зарплата", key: "orig_Среднемесячная зарплата по организационно-правовым формам" },
                { label: "Индекс физического объёма, по всей промышленности", key: "orig_Индекс физического объёма, по всей промышленности" },
                { label: "Объём промышленной продукции по всей промышленности", key: "orig_Объём промышленной продукции по всей промышленности" },
                { label: "Всего действующих крупных и средних промышленных предприятий", key: "orig_Всего действующих крупных и средних промышленных предприятий" },
                { label: "Количество зарегистрированных крупных предприятий", key: "orig_Количество зарегистрированных крупных предприятий" },
                { label: "Количество зарегистрированных малых предприятий", key: "orig_Количество зарегистрированных малых предприятий" },
                { label: "Количество зарегистрированных средних предприятий", key: "orig_Количество зарегистрированных средних предприятий" },
                { label: "Количество зарегистрированных субъектов всего по району", key: "orig_Количество зарегистрированных субъектов всего по району" },
                { label: "Количество действующих субъектов всего по району", key: "orig_Количество действующих субъектов всего по району" },
                { label: "Действующие зарегистрированные субъекты малого предпринимательства", key: "orig_Действующие зарегистрированные субъекты малого предпринимательства" },
                { label: "Всего зарегистрированных субъектов малого предпринимательства", key: "orig_Всего зарегистрированных субъектов малого предпринимательства (юрид. и физ. лица)" },
                { label: "Количество действующих государственных предприятий", key: "orig_Количество действующих государственных предприятий по организационно-правовым формам" },
                { label: "Количество действующих частных предприятий", key: "orig_Количество действующих частных предприятий по организационно-правовым формам" },
                { label: "Количество действующих иностранных предприятий", key: "orig_Количество действующих иностранных предприятий по организационно-правовым формам" },

                // 🚨 Безопасность и смертность
                { label: "Коэффициент младенческой смертности на 1000 человек", key: "orig_Коэффицент младенческой смертности на 1000 человек" },
                { label: "Умершие от несчастных случаев, отравлений и травм", key: "orig_Умершие  от несчастных случаев, отравлений и травм" },
                { label: "Умершие от самоубийств", key: "orig_Умершие  от самоубийств" },
                { label: "Умершие от болезней органов дыхания", key: "orig_Умершие от болезней органов дыхания" },
                { label: "Умершие от болезней органов пищеварения", key: "orig_Умершие от болезней органов пищеварения" },
                { label: "Умершие от болезней системы кровообращения", key: "orig_Умершие от болезней системы кровообращения" },
                { label: "Умершие от гипертонической болезни", key: "orig_Умершие от гипертонической болезни" },
                { label: "Умершие от гриппа, ОРЗ и пневмонии", key: "orig_Умершие от гриппа, ОРЗ и пневмонии" },
                { label: "Умершие от дорожно-транспортных происшествий", key: "orig_Умершие от дорожно-транспортных происшествий" },
                { label: "Умершие от злокачественных новообразований", key: "orig_Умершие от злокачественных новообразований" },
                { label: "Умершие от инфекционных и паразитарных болезней", key: "orig_Умершие от инфекционных и паразитарных болезней" },
                { label: "Умершие от ишемической болезни сердца", key: "orig_Умершие от ишемической болезни сердца" },
                { label: "Умершие от новообразований", key: "orig_Умершие от новообразований" },
                { label: "Умершие от острого инфаркта миокарда", key: "orig_Умершие от острого инфаркта миокарда" },
                { label: "Умершие от стенокардии", key: "orig_Умершие от стенокардии" },
                { label: "Умершие от сосудистого поражения мозга", key: "orig_Умершие от судистого поражения мозга" },
                { label: "Умершие от убийств", key: "orig_Умершие от убийств" },

                // 💡 Социальное благополучие
                { label: "Число браков", key: "orig_Число браков" },
                { label: "Число разводов", key: "orig_Число разводов" },
                { label: "Коэффициент брачности на 1000 человек", key: "orig_Коэффицент брачности на 1000 человек" },
                { label: "Коэффициент разводимости на 1000 человек", key: "orig_Коэффицент разводимости на 1000 человек" },

                // 🎓 Образование
            ];

            // Генерация HTML для таблицы
            const tableRows = parameters.map(param => {
                // Извлечение значения с учётом проверки ключей
                const value = latestQuarter.hasOwnProperty(param.key) ? latestQuarter[param.key] : '-';

                const displayValue = (value !== undefined && value !== null && value !== "")
                    ? value.toLocaleString() 
                    : '-';

                return `
                    <tr>
                        <td style="padding: 8px;">${param.label}</td>
                        <td style="padding: 8px;">${displayValue}</td>
                    </tr>
                `;
            }).join('');

            // Обновляем HTML боковой панели
            sidebarContent.innerHTML = `
                <h3>${latestQuarter.orig_district_name || 'Неизвестный район'}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr>
                        <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Параметр</th>
                        <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 8px;">Значение</th>
                    </tr>
                    ${tableRows}
                </table>
            `;
        }



        // Обновление графика
        function updateChart(districtData) {
            const ctx = document.getElementById('qChart').getContext('2d');

            // Проверка наличия данных
            if (!districtData || districtData.length === 0) {
                console.warn('Нет данных для построения графика.');
                return;
            }

            // Сортировка данных по дате
            const chartData = districtData
                .filter(d => d.orig_indicator_date && d.QoL !== undefined)
                .sort((a, b) => new Date(a.orig_indicator_date) - new Date(b.orig_indicator_date))
                .map(d => ({
                    date: d.orig_indicator_date,
                    value: d.QoL,
                    delta: d.QoL_change || 0
                }));

            const labels = chartData.map(item => item.date);
            const values = chartData.map(item => item.value);
            const changes = chartData.map(item => item.delta);

            // Цвета точек для QoL
            const pointColorsQoL = values.map(value => {
                if (value < 0.1) return '#d7191c'; // Очень низкий QoL (красный)
                if (value < 0.3) return '#fdae61'; // Средний QoL (оранжевый)
                if (value < 0.5) return '#a6d96a'; // Выше среднего QoL (зелёный)
                return '#1a9641';                // Высокий QoL (тёмно-зелёный)
            });

            // Цвета точек для изменения QoL
            const pointColorsChange = changes.map(change => {
                if (change > 0) return '#1a9641'; // Рост (зелёный)
                if (change < 0) return '#d7191c'; // Падение (красный)
                return '#6c757d';                // Без изменений (серый)
            });

            // Удаляем предыдущий график, если он существует
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Создание нового графика
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Индекс QoL',
                            data: values,
                            borderColor: '#1a9641', // Зелёный цвет для линии QoL
                            backgroundColor: 'rgba(26, 150, 65, 0.1)',
                            pointBackgroundColor: pointColorsQoL,
                            pointRadius: 5,
                            tension: 0.3
                        },
                        {
                            label: 'Изменение QoL (%)',
                            data: changes,
                            borderColor: '#6c757d', // Серый цвет для линии изменения
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            pointBackgroundColor: pointColorsChange,
                            pointRadius: 4,
                            borderDash: [5, 5],
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: {
                            display: true,
                            text: 'Динамика индекса качества жизни'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw !== null ? context.raw.toFixed(2) : "Нет данных";
                                    return context.dataset.label.includes('QoL')
                                        ? `${context.dataset.label}: ${value}`
                                        : `${context.dataset.label}: ${value}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Дата' }
                        },
                        y: {
                            title: { display: true, text: 'Индекс QoL' },
                            beginAtZero: true
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Изменение QoL (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }


        function drawMultiDistrictChart() {
            const canvas = document.getElementById("multiDistrictChart");
            if (!canvas) {
                console.warn("Элемент multiDistrictChart не найден.");
                return;
            }
            const ctx = canvas.getContext("2d");

            if (!fullDataset || fullDataset.length === 0) {
                console.warn("Нет данных для построения графика.");
                return;
            }

            // Группировка данных по районам
            const groupedData = {};
            fullDataset.forEach(entry => {
                if (!entry.orig_district_name || entry.QoL === undefined) return; // Пропуск некорректных данных
                if (!groupedData[entry.orig_district_name]) {
                    groupedData[entry.orig_district_name] = [];
                }
                groupedData[entry.orig_district_name].push({
                    date: entry.orig_indicator_date,
                    QoL: entry.QoL
                });
            });

            const sortedDistricts = Object.keys(groupedData).sort();
            if (sortedDistricts.length === 0) {
                console.warn("Нет данных по районам.");
                return;
            }

            // Сортировка всех дат
            const allDates = [...new Set(fullDataset.map(d => d.orig_indicator_date))].sort();

            // Функция генерации цвета для графика
            function generateColor(index, total) {
                const hue = (index / total) * 360;
                return `hsl(${hue}, 70%, 50%)`;
            }

            const datasets = sortedDistricts.map((district, index) => {
                const color = generateColor(index, sortedDistricts.length);
                const dataMap = Object.fromEntries(groupedData[district].map(d => [d.date, d.QoL]));
                const values = allDates.map(date => dataMap[date] !== undefined ? dataMap[date] : null);

                return {
                    label: district,
                    data: values,
                    borderColor: color,
                    backgroundColor: "transparent",
                    pointRadius: 2,
                    tension: 0.3
                };
            });

            if (window.multiDistrictChartInstance) {
                window.multiDistrictChartInstance.destroy();
            }

            window.multiDistrictChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: allDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: "Индекс качества жизни по районам" },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw !== null ? context.raw.toFixed(2) : "Нет данных"}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: "Дата" } },
                        y: { title: { display: true, text: "Индекс QoL" }, beginAtZero: true }
                    }
                }
            });
        }


        document.addEventListener("DOMContentLoaded", () => {
            // Получаем элементы управления
            const fullscreenToggle = document.getElementById("fullscreen-toggle");
            const showCurrentQ = document.getElementById("showCurrentQ");
            const showPreviousQ = document.getElementById("showPreviousQ");
            const opacitySlider = document.getElementById("opacity-slider");
            const sidebar = document.getElementById("sidebar");
            const toggleSidebarButton = document.getElementById("toggleSidebar");
            const chartContainer = document.getElementById("chartContainer");
            const multiChartContainer = document.getElementById("multiDistrictChartContainer");
            const expandChartButton = document.getElementById("expandChart");
            const multiChartFullscreenButton = document.getElementById("toggleMultiDistrictFullscreen");
            const showMultiDistrictChart = document.getElementById("showMultiDistrictChart");
            const showSingleDistrictChart = document.getElementById("showSingleDistrictChart");
            const methodologyButton = document.getElementById("showMethodology");
            const modal = document.getElementById("modal");
            const closeModalButton = document.querySelector(".close-modal");

            let isFullscreen = false;
            let showQMode = "current"; // Режим отображения QoL

            /** 🌐 Полноэкранный режим */
            fullscreenToggle.addEventListener("click", () => {
                const element = document.documentElement;

                if (!isFullscreen) {
                    if (element.requestFullscreen) element.requestFullscreen();
                    else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
                    else if (element.msRequestFullscreen) element.msRequestFullscreen();

                    fullscreenToggle.innerHTML = `<i class="fas fa-compress"></i>`;
                    fullscreenToggle.title = "Свернуть";
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    else if (document.msExitFullscreen) document.msExitFullscreen();

                    fullscreenToggle.innerHTML = `<i class="fas fa-expand"></i>`;
                    fullscreenToggle.title = "Во весь экран";
                }
                isFullscreen = !isFullscreen;
            });

            /** 🔄 Переключение между текущим QoL и изменением QoL */
            function updateLayerColor() {
                if (!map.isStyleLoaded()) {
                    console.warn("Карта ещё не загружена. Попробуйте позже.");
                    return;
                }

                const property = showQMode === "current" ? "QoL" : "QoL_change";
                map.setPaintProperty("districts-layer", "fill-color", [
                    "step",
                    ["get", property],
                    "#6c757d", // Нет данных
                    0.1, "#d7191c",
                    0.3, "#fdae61",
                    0.5, "#a6d96a",
                    0.7, "#1a9641"
                ]);
            }

            showCurrentQ.addEventListener("click", () => {
                showQMode = "current";
                updateLayerColor();
            });

            showPreviousQ.addEventListener("click", () => {
                showQMode = "previous";
                updateLayerColor();
            });

            /** 🎚️ Изменение прозрачности карты */
            opacitySlider.addEventListener("input", (e) => {
                const opacity = parseFloat(e.target.value);
                if (map.isStyleLoaded()) {
                    map.setPaintProperty("districts-layer", "fill-opacity", opacity);
                }
            });

            /** 📌 Скрытие/отображение боковой панели */
            toggleSidebarButton.addEventListener("click", () => {
                sidebar.classList.toggle("collapsed");
                toggleSidebarButton.classList.toggle("collapsed");

                const isCollapsed = sidebar.classList.contains("collapsed");
                toggleSidebarButton.style.left = isCollapsed ? "20px" : "410px";

                const icon = toggleSidebarButton.querySelector("i");
                icon.classList.toggle("fa-chevron-left", !isCollapsed);
                icon.classList.toggle("fa-chevron-right", isCollapsed);
            });

            /** 📊 Сворачивание/разворачивание графика */
            function toggleChart(chart, button) {
                chart.classList.toggle("minimized");
                chart.classList.toggle("expanded");

                button.innerHTML = chart.classList.contains("expanded")
                    ? `<i class="fas fa-compress"></i>`  // "Свернуть"
                    : `<i class="fas fa-expand"></i>`;   // "Развернуть"

                // Перерисовка графика после изменения размеров
                if (chart.contains(document.getElementById("qChart")) && window.chartInstance) {
                    window.chartInstance.resize();
                }
                if (chart.contains(document.getElementById("multiDistrictChart")) && window.multiDistrictChartInstance) {
                    window.multiDistrictChartInstance.resize();
                }
            }

            expandChartButton.addEventListener("click", () => {
                toggleChart(chartContainer, expandChartButton);
            });

            multiChartFullscreenButton.addEventListener("click", () => {
                if (!document.fullscreenElement) {
                    multiChartContainer.requestFullscreen().catch(err => {
                        console.error(`Ошибка при входе в полноэкранный режим: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            /** 🔄 Переключение между одиночным и мульти-графиком */
            showSingleDistrictChart.addEventListener("click", () => {
                chartContainer.classList.remove("minimized");
                chartContainer.classList.add("expanded");
                multiChartContainer.classList.add("minimized");
            });

            showMultiDistrictChart.addEventListener("click", () => {
                multiChartContainer.classList.remove("minimized");
                multiChartContainer.classList.add("expanded");
                chartContainer.classList.add("minimized");
            });

            /** 📖 Обработчик для модального окна методологии */
            methodologyButton.addEventListener("click", () => {
                modal.style.display = "block";
            });

            closeModalButton.addEventListener("click", () => {
                modal.style.display = "none";
            });

            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        });



        document.getElementById("showMultiDistrictChart").addEventListener("click", () => {
            const container = document.getElementById("multiDistrictChartContainer");
            container.classList.toggle("minimized");
            container.classList.toggle("expanded");

            drawMultiDistrictChart();
        });

        document.getElementById("toggleMultiDistrictFullscreen").addEventListener("click", () => {
            const chartContainer = document.getElementById("multiDistrictChartContainer");
            if (!document.fullscreenElement) {
                chartContainer.requestFullscreen().catch(err => {
                    console.error(`Ошибка при входе в полноэкранный режим: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });

      

    </script>
</body>

</html>