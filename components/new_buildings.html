<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Шаговая доступность к зелёным зонам</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <style>
        /* Общие стили */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: #eaeaea; /* Нежный светло-серый фон */
            color: #333;
        }

        #map {
            flex: 1;
        }

        /* Сайдбар */
        .sidebar {
            width: 280px; /* Чуть шире для удобства */
            padding: 25px;
            background: linear-gradient(145deg, #142136, #1c2a4a); /* Градиент для глубины */
            color: #fdfdfd;
            font-size: 15px;
            line-height: 1.8;
            overflow-y: auto;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.25); /* Чёткая тень */
        }

        .sidebar h3 {
            font-size: 20px;
            color: #4de1ff; /* Акцентный светлый голубой */
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Тонкая линия */
            padding-bottom: 5px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .sidebar ul {
            list-style-type: disc;
            margin-top: 10px;
            padding-left: 20px;
        }

        .sidebar ul li {
            margin-bottom: 8px;
            color: #dfe8ff; /* Светлый оттенок текста */
            font-size: 14px;
        }

        /* Легенда */
        .legend {
            background: linear-gradient(145deg, #ffffff, #e4e4e4); /* Лёгкий градиент */
            border-radius: 15px; /* Мягкие края */
            padding: 15px;
            position: fixed;
            top: 15px; /* Верхний край */
            right: 15px; /* Правый край */
            width: 250px; /* Удобная ширина */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Приятная тень */
            z-index: 3;
            font-size: 15px;
            font-family: 'Arial', sans-serif;
        }

        .legend h4 {
            font-size: 16px;
            color: #444;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .legend div {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .legend div span {
            display: inline-block;
            height: 15px;
            width: 15px;
            margin-right: 10px;
            border-radius: 4px; /* Квадраты со слегка скруглёнными углами */
        }

        .legend .red {
            background-color: rgba(200, 50, 50, 0.8);
        }

        .legend .green {
            background-color: rgba(13, 70, 13, 0.8);
        }

        .legend .gradient {
            background: linear-gradient(to right, rgba(255, 182, 193, 0.8), rgba(139, 0, 0, 0.8));
            height: 15px;
            width: 100px;
            border-radius: 5px;
        }

        /* Кнопки */
        .button-container-left {
            position: fixed; /* Фиксированное положение */
            bottom: 25px; /* Расстояние от нижнего края */
            left: 25px; /* Расстояние от левого края */
            display: flex;
            gap: 15px; /* Расстояние между кнопками */
            z-index: 3;
        }

        .button-container-right {
            position: fixed; /* Фиксированное положение */
            bottom: 25px; /* Расстояние от нижнего края */
            right: 25px; /* Расстояние от правого края */
            display: flex;
            gap: 15px; /* Расстояние между кнопками */
            z-index: 3;
        }

        .button, .apply-button {
            padding: 14px 28px; /* Просторнее */
            background: linear-gradient(145deg, #7b9cc0, #2e4359); /* Объёмный градиент */
            color: white;
            border: none;
            border-radius: 12px; /* Мягкие края */
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Глубокая тень */
        }

        .button:hover, .apply-button:hover {
            background: linear-gradient(145deg, #5f7691, #253d54); /* Градиент при наведении */
            transform: scale(1.05); /* Увеличение при наведении */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* Более выраженная тень */
        }

        .button:active, .apply-button:active {
            transform: scale(0.95); /* Эффект нажатия */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Уменьшение тени */
        }

        button.apply-button, button.button {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            font-size: 20px; /* Размер иконки */
            padding: 0;
        }

        button.apply-button:hover::after, button.button:hover::after {
            content: attr(title); /* Текст подсказки из атрибута title */
            position: absolute;
            bottom: 60px; /* Расстояние от кнопки */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        /* Скрытая боковая панель */
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
            transition: width 0.3s ease, padding 0.3s ease;
        }

        /* Кнопка управления боковой панелью */
        .toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 280px; /* Расположение кнопки у края панели */
            z-index: 4;
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #7b9cc0, #2e4359); /* Градиент */
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease, background 0.2s ease;
        }

        .toggle-sidebar:hover {
            background: linear-gradient(145deg, #5f7691, #253d54); /* Градиент при наведении */
        }

        .toggle-sidebar.collapsed {
            left: 0; /* Сдвигаем кнопку, когда панель скрыта */
        }

        .toggle-sidebar i {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .toggle-sidebar.collapsed i {
            transform: rotate(180deg); /* Поворачиваем стрелку */
        }


        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        /* Всплывающие подсказки */
        .custom-popup .mapboxgl-popup-content {
            font-size: 16px;
            background: rgba(40, 40, 40, 0.95); /* Тёмный фон с акцентом */
            color: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4); /* Глубокая тень */
            text-align: center;
        }

        .custom-popup .mapboxgl-popup-tip {
            border-top-color: rgba(40, 40, 40, 0.95);
        }

        /* Эффекты на карте */
        .mapboxgl-popup-close-button {
            color: white; /* Белая кнопка закрытия */
            font-size: 18px; /* Чуть крупнее */
            opacity: 0.8; /* Лёгкая прозрачность */
            transition: opacity 0.2s ease;
        }

        .mapboxgl-popup-close-button:hover {
            opacity: 1; /* Полная видимость при наведении */
        }

</style>

</head>
<body>
    <div class="sidebar" id="sidebar">
        <h3>Зоны рекреации</h3>
        <ul>
            <li>Баскетбольная площадка</li>
            <li>Волейбольная площадка</li>
            <li>Площадка для воркаута</li>
            <li>Спортивная площадка</li>
            <li>Теннисный корт</li>
            <li>Футбольное поле</li>
        </ul>
        <h3>Зелёные зоны</h3>
        <ul>
            <li>Аллея</li>
            <li>Благоустроенный участок</li>
            <li>Бульвар</li>
            <li>Зелёная зона</li>
            <li>Набережная</li>
            <li>Парк</li>
            <li>Роща</li>
            <li>Сквер</li>
            <li>Терренкур</li>
        </ul>
    </div>
    
    <button class="toggle-sidebar" id="toggleSidebar" title="Скрыть панель">
        <i class="fas fa-chevron-left"></i>
    </button>
    
    
    <div id="map"></div>
    
    <div class="legend">
        <h4>Шаговая доступность к зелёным зонам</h4>
        <div>
            <span class="red"></span> Вне шаговой доступности 
        </div>
        <div>
            <span class="green"></span> В шаговой доступности
        </div>
        <div style="display: flex; align-items: center;">
            <span class="gradient"></span> Численность населения
        </div>
    </div>
    
    <div class="button-container-left">
        <button class="button" onclick="resetMap()" title="Сбросить карту">
            <i class="fas fa-undo"></i>
        </button>
    </div>
    
    <div class="button-container-right">
        <button class="apply-button" id="apply-800" onclick="applyAccessibility(800)" title="Прогноз шаговой доступности на 800 м">
            <i class="fas fa-walking"></i>
        </button>
        <button class="apply-button" id="apply-1500" onclick="applyAccessibility(1500)" title="Прогноз шаговой доступности на 1500 м">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="button" onclick="toggleFullScreen()" title="Во весь экран">
            <i class="fas fa-expand"></i>
        </button>
    </div>
    
    
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWxpbmFjaCIsImEiOiJjbGlpcnZpaTgwMTZ4M2twaGo1NjRsNHhhIn0.9jw_R_D1i1nqOtaolld-dQ';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/alinach/cm1j0n58p00jq01qp98m35mrk',
        center: [76.945, 43.255],
        zoom: 11
    });
    
    let greenZonesData, recommendationsData, newZonesData, newZonesData1500;
    
    // Загрузка данных
    async function loadData() {
        try {
            const greenZonesUrl = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/access_green_zones.geojson';
            const recommendationsUrl = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/rec_green_zones.geojson';
            const newZonesUrl800 = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/new_green_ac.geojson';
            const newZonesUrl1500 = 'https://raw.githubusercontent.com/alinachrks/fun_house/main/new_green_1.5.geojson';

            greenZonesData = await (await fetch(greenZonesUrl)).json();
            recommendationsData = await (await fetch(recommendationsUrl)).json();
            newZonesData = await (await fetch(newZonesUrl800)).json();
            newZonesData1500 = await (await fetch(newZonesUrl1500)).json();

            // Добавляем зелёные зоны на карту
            map.addSource('green-zones', {
                'type': 'geojson',
                'data': greenZonesData
            });
            map.addLayer({
                'id': 'green-zones-layer',
                'type': 'fill',
                'source': 'green-zones',
                'paint': {
                    'fill-color': [
                        'match',
                        ['get', 'type'],
                        'red', [
                            'interpolate',
                            ['linear'],
                            ['get', 'Кол-во горожан'],
                            0, 'rgba(255, 182, 193, 0.5)',
                            500, 'rgba(139, 0, 0, 0.8)'
                        ],
                        'green', [
                            'interpolate',
                            ['linear'],
                            ['get', 'Кол-во горожан'],
                            50, 'rgba(144, 238, 144, 0.5)',
                            500, 'rgba(0, 100, 0, 0.8)'
                        ],
                        'rgba(128, 128, 128, 0.5)'
                    ],
                    'fill-opacity': 0.5
                }
            });

            // Добавляем точки с рекомендациями
            map.addSource('recommendations', {
                'type': 'geojson',
                'data': recommendationsData
            });

            map.addLayer({
                'id': 'recommendations-layer',
                'type': 'circle',
                'source': 'recommendations',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': 'rgba(255, 69, 0, 0.9)', // Яркий оранжевый
                    'circle-stroke-color': '#FFFFFF', // Белая обводка
                    'circle-stroke-width': 2,
                    'circle-opacity': 1 // Полностью непрозрачные по умолчанию
                }
            });

            // Переместим слой 'recommendations-layer' поверх всех других
            map.on('load', () => {
                if (map.getLayer('recommendations-layer')) {
                    map.moveLayer('recommendations-layer');
                }
            });

            // Обработка кликов по точкам
            map.on('click', 'recommendations-layer', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const name = e.features[0].properties['Наименование'] || 'Без названия';

                // Удаление предыдущей всплывающей подсказки
                if (currentPopup) {
                    currentPopup.remove();
                }

                // Создание новой фиксированной всплывающей подсказки
                currentPopup = new mapboxgl.Popup({
                    closeButton: true, // Включаем кнопку закрытия
                    closeOnClick: false, // Подсказка остаётся при клике в другое место
                    className: 'custom-popup'
                })
                    .setLngLat(coordinates)
                    .setHTML(`<strong>${name}</strong>`) // Исправление: используем обратные кавычки для шаблонной строки
                    .addTo(map);
            });

            let hoverPopup = null; // Для временной подсказки при наведении
            let clickPopup = null; // Для фиксированной подсказки при клике

            // Наведение на точку
            map.on('mouseenter', 'recommendations-layer', (e) => {
                map.getCanvas().style.cursor = 'pointer';

                const coordinates = e.features[0].geometry.coordinates.slice();
                const name = e.features[0].properties['Наименование'] || 'Без названия';

                // Удаляем предыдущую временную подсказку
                if (hoverPopup) {
                    hoverPopup.remove();
                    hoverPopup = null;
                }

                // Создаём временную подсказку
                hoverPopup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    className: 'custom-popup'
                })
                    .setLngLat(coordinates)
                    .setHTML(`<strong>${name}</strong>`) // Исправление: используем обратные кавычки
                    .addTo(map);
            });

            // Уход курсора с точки
            map.on('mouseleave', 'recommendations-layer', () => {
                map.getCanvas().style.cursor = '';

                // Удаляем временную подсказку
                if (hoverPopup) {
                    hoverPopup.remove();
                    hoverPopup = null;
                }
            });

            // Добавляем зоны доступности
            map.addSource('new-zones', { type: 'geojson', data: newZonesData });
            map.addLayer({
                id: 'new-zones-layer',
                type: 'fill',
                source: 'new-zones',
                paint: {
                    'fill-color': 'rgba(21, 102, 31, 0.9)', // Зелёный цвет по умолчанию
                    'fill-opacity': 0.6 // Прозрачность по умолчанию
                },
                layout: { visibility: 'none' }
            });

            map.addSource('new-zones-1500', { type: 'geojson', data: newZonesData1500 });
            map.addLayer({
                id: 'new-zones-1500-layer',
                type: 'fill',
                source: 'new-zones-1500',
                paint: {
                    'fill-color': 'rgba(198, 222, 18, 0.9)', // Синий цвет по умолчанию
                    'fill-opacity': 0.6 // Прозрачность по умолчанию
                },
                layout: { visibility: 'none' }
            });
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    }


    // Управление видимостью слоёв (независимая активация с изменением прозрачности и цвета)
    function toggleAccessibility(layer) {
        const otherLayer = layer === 'new-zones-layer' ? 'new-zones-1500-layer' : 'new-zones-layer';

        // Получаем текущее состояние видимости слоя
        const currentVisibility = map.getLayoutProperty(layer, 'visibility');

        if (currentVisibility === 'none') {
            // Активируем слой
            map.setLayoutProperty(layer, 'visibility', 'visible');
            map.setPaintProperty(layer, 'fill-color', 'rgba(26, 112, 20, 0.9)');
            map.setPaintProperty(otherLayer, 'fill-opacity', 0.6);
        } else {
            // Деактивируем слой
            map.setLayoutProperty(layer, 'visibility', 'none');
            map.setPaintProperty(otherLayer, 'fill-opacity', 0.3);
        }
    }

    // Связываем кнопки с независимыми слоями
    document.getElementById('apply-800').addEventListener('click', () => toggleAccessibility('new-zones-layer'));
    document.getElementById('apply-1500').addEventListener('click', () => toggleAccessibility('new-zones-1500-layer'));

    document.getElementById('toggleSidebar').addEventListener('click', function () {
        const sidebar = document.getElementById('sidebar');
        const toggleButton = document.getElementById('toggleSidebar');

        // Переключаем класс `collapsed`
        sidebar.classList.toggle('collapsed');
        toggleButton.classList.toggle('collapsed');

        // Обновляем tooltip и направление стрелки
        const isCollapsed = sidebar.classList.contains('collapsed');
        toggleButton.setAttribute('title', isCollapsed ? 'Развернуть панель' : 'Скрыть панель');
    });


    // Сброс карты
    function resetMap() {
        map.flyTo({ center: [76.945, 43.255], zoom: 11 });
        map.setLayoutProperty('new-zones-layer', 'visibility', 'none');
        map.setLayoutProperty('new-zones-1500-layer', 'visibility', 'none');
    }

    // Полноэкранный режим
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    map.on('load', loadData);


    </script>
    </body>
    </html>